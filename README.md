# Задание 2
## Описание задания
1. Считать данные из [[наша ссылка][training.csv]]. 
    1. Провести визуальную оценку, отрисовав ряд и скользящую статистику(среднее, стандартное отклонение). Построить график, на котором будет отображен сам ряд и различные скользящие статистики.
    2. Провести тест Дики - Фуллера.
    Сделать выводы из полученных результатов. Оценить достоверность статистики.
  3. Разложить временной ряд на тренд, сезональность, остаток в соответствии с аддитивной, мультипликативной моделями. Визуализировать их, оценить стационарность получившихся рядов, сделать выводы.
  4. Проверить является ли временной ряд интегрированным порядка k. Если является, применить к нему модель ARIMA, подобрав необходимые параметры с помощью функции автокорреляции и функции частичной автокорреляции. Выбор параметров обосновать. Отобрать несколько моделей. Предсказать значения для тестовой выборки. Визуализировать их, посчитать r2 score для каждой из моделей. Произвести отбор наилучшей модели с помощью информационного критерия Акаике. Провести анализ получившихся результатов. 
  
## Используемые понятия

Под временным рядом понимаются последовательно измеренные через некоторые (зачастую равные) промежутки времени данные.
Ряд yt называется слабо стационарным (weak stationarity) или стационарным в широком смысле, если такие статистические характеристики
временного ряда как его математическое ожидание (среднее), дисперсия (ср. кв. отклонение) и ковариация не зависят от момента времени
E[y] = Const, D[y] = Const, Cov[yk, y(k-1)] = R(k)  
Если нарушается хотя бы одно из этих условий, то ряд называется нестационарным.

Скользящая средняя (Moving Average - MA) - среднее арифметическое значений исходной функции за установленный период. Скользящие средние позволяют сгладить как случайные, так и периодические колебания, выявить имеющуюся тенденцию в развитии процесса.


### Интегрированность, тест Дики - Фуллера
*Тест Дики-Фуллера* используется для проверки ряда на стационарность. Он проверяет ряд на наличие так называемых единичных корней.
Временной ряд имеет *единичный корень* (хотя бы один), если его первые разности образуют стационарный ряд.

*Обозн.* y(t) ~ I(1), т.е. Δy(t)=y(t)-y(t-1) ~ I(0), где Δ - разностный оператор, I(j) - означает, что ряд является интегрированным порядка j, I(0) - ряд стационарен.
Временной ряд называется *интегрированным порядка `k`*, если разности ряда k-го порядка `Δ^k x(t)` являются стационарными, а разности меньшего порядка (и сам временной ряд) не являются стационарными рядами.
* Δ yk   = y(k+1) - yk
* Δ^2 yk = Δ y(k+1) - Δ yk = y(k+2) - 2y(k+1) + yk
* Δ^m yk = Δ^m-1 y(k+1) - Δ^m-1 yk, где Δ - разностный оператор

*Обозн.* yk ~ I(k) - интегрированный временной ряд порядка k

Вообще говоря, тест Дики-Фуллера проверяет значение коэффициента `a` в авторегрессионном уравнении 1-го порядка. Оно имеет вид:

y(t) = a * y(t-1) + ε(t), ε(t) - ошибка
* a=1   => есть единичные корни => стационарности нет
* |a|<1 => нет единичных корней => есть стационарность
* |a|>1 => не свойственно для временных рядов, которые встречаются в реальной жизни - требуется более сложный анализ

Преобразуем уравнение:

y(t) = a * y(t-1) + ε(t)  
y(t) - y(t-1) = a * y(t-1) - y(t-1) + ε(t)  
Δy(t) = (a-1) * y(t-1) + ε(t)  
**Δy(t) = b * y(t-1) + ε(t)**, где b=a-1  

Сформулируем основную и альтернативную гипотезы:
* Основная гипотеза: H0: b=0 - существует единичный корень, ряд нестационарный.
* Альтернативаная гипотеза: H1: b<0 - единичного корня нет, ряд стационарный

Для того чтобы проверить временной ряд y на порядок интегрируемости, следует рассчитать значение t-статистики Стьюдента для
параметра b и сравнить его с верхним и нижним критическими значениями DF-статистики из таблицы теста Дики-Фуллера. Если для n наблюдений
значение расчетной t-статистики sm.tsa.adfuller(ts) меньше, чем нижнее критическое значение, нулевую гипотезу b=0 отклоняют и принимают альтернативную о стационарности процесса yt. В противном случае, нулевая гипотеза не может быть отклонена. Если нулевая гипотеза не отклоняется, можно лишь утверждать, что процесс yt нестационарен, т.е. либо он интегрируем более высокого порядка, либо неинтегрируем вообще.

### Тренд, сезональность, остаток. Аддитивная и мультипликативная модели
*Трендовая* составляющая отражает влияние долговременных факторов и соответствует устойчивой и долговременной тенденции изменения временного ряда.
*Сезонная* компонента s(τ i) связана с наличием факторов, действующих с заранее известной периодичностью. Это регулярные колебания, которые носят периодический или близкий к нему характер.
*Остатком* временного ряда называется разница между предсказанным и наблюдаемым значением.

* Общий вид *аддитивной модели*: Y = T + S + E;
* Общий вид *мультипликативной модели*: Y = T * S * E;
* T - тренд, S - сезональность, E - остаток
### Преобразование Бокса-Кокса
Попробуем применить преобразование, чтобы приблизить имеющееся распределение к нормальному. Будем использовать преобразование Бокса-Кокса (логарифмирование – это частный случай трансформации Бокса-Кокса) 
y_new=(y^p−1)/p , если p≠0 
y_new=ln(y), если p=0

#### ARIMA и SARIMAX
*Авторегрессионная (AR-) модель (англ. autoregressive model)* — модель временных рядов, в которой значения временного ряда в данный момент линейно зависят от предыдущих значений этого же ряда. Авторегрессионный процесс порядка p (AR(p)-процесс) определяется следующим образом  
  Y_t = c + Σ(from i=1 to p)a_i * X_(t-i) + e_t, где a_i - параматеры модели (коэффициенты авторегрессии), c — постоянная
  
*MA (moving average model)* - модель скользящего среднего, в которой моделируемый уровень временного ряда можно представить как линейную функцию прошлых ошибок, т.е. разностей между прошлыми фактическими и теоретическими уровнями.  
  Y_t = Σ(from j=0 to q)b_j * e_(t-j), где b_j - параматеры модели  
  
*ARIMA (англ. autoregressive integrated moving average)*- интегрированная модель авторегрессии — скользящего среднего — модель и методология анализа временных рядов.  
ARIMA(p, d, q), где p - порядок AR(p), d - порядок интегрированности, q - порядок MA(q)  
Δ^d(Y_t) = c + Σ(from i=1 to p) * a_i * Δ^d(Y_(t-1)) + Σ(from j=1 to q)b_j * e_(t-j)
  
*SARIMAX* - модель временных рядов, построенная на основе расширенной (eXtended) модели ARIMA с добавлением сезонности (Seasonal).
Здесь аргумент order устанавливает параметры  (p, d, q), в то время как seasonal_order определяет параметры (P, D, Q, S). P - порядок сезонной составляющей SAR(P), D — порядок интегрирования сезонной составляющей, Q — порядок сезонной составляющей SMA(Q), s — размерность сезонности(месяц, квартал и т.д.)


### AIC - информационный критерий Акаике
*Критерий Акаике (Akaike's information criterion, AIC)* - критерий выбора из нескольких статистических моделей с разным числом параметров. Критерий связан с понятием расстояния Кульбака — Лейблера, при помощи которого можно оценить расстояние между моделями. При применении критерия лучшей считается модель, в достаточной мере полно описывающая данные с наименьшим количеством параметров.

 ### R2-score
*Коэффициент детерминации (R^2)* - доля дисперсии зависимой переменной, объясняемая рассматриваемой моделью зависимости.  
Лучший результат, который может дать R2 score - это 1.0. Если R2 принимает отрицательные значения или значения, превышающие 1.0, то это говорит об очень большой неточности предсказания модели.

## Подход к решению

1. Чтение данных из `training.csv` командой `pd.read_csv('training.csv')`
2. Проверка на стационарность в функции statTest(dataset, flag) при помощи теста Дики-Фуллера `sm.tsa.adfuller`  
   Вычислили скользящее среднее и стандартное отклонение с помощью `ts.rolling().mean` и `ts.rolling().std`
3. В реализованной функции model c помощью функции `seasonal_decompose` раскладываем временной ряд на тренд, сезональность и остаток, после чего визуализируем их и проверяем на стационарность, используя тест Дики-Фуллера.  
Построение графиков автокорреляции acf и частичной автокорреляции pacf для определения параметров p, q для модели ARIMA и p, q, P, Q для SARIMAX. С помощью этих графиков найдем начальные приближения парметров. Из ACF видно, что 25 - номер последнего несезонного лага, при котором автокорреляция значима, поэтому q = 25, но мы брали начальное приближение q = 10, чтобы не очень усложнять модель. Длину сезона S мы взяли 12, а 2 - это номер последнего сезонного лага (лаг 24), при котором автокорреляция значима, поэтому Q = 2. Аналогично определим начальные приближения для p и P из PACF. P = 4 (лаг 48 значимый), p = 5 (5 лаг значимый). Далее мы строим модели SARIMAX с параметрами, меняющимися от 0 до начальных приближений, и находим лучшую по критерию Акаике.
 3. Нахождения порядка интегрированности временного ряда с помощью реализованнной функции iOrder(dataset): таким образом находим параметр d, найдя порядок интегрированности для компоненты ряда, представляющую сезональность, находим D

## Библиотеки и функции
* pandas
   * rolling(window).mean() - вычисляет скользящее среднее; window - размер движущегося "окна" - число наблюдений для подсчёта статистики
   * rolling(window).std() - вычисляет стандартное отклонение; window - размер движущегося "окна" - число наблюдений для подсчёта статистики
* statsmodels - представляет собой пакет Python, который позволяет пользователям исследовать данные, оценивать статистические модели и выполнять статистические тесты;
   * statsmodels.tsa.statespace.tools.diff(series, k_diff=1, ...) - дифференцирует ряд; series - дифференцируемый ряд, k_diff - число дифференцирований
   * statsmodels.tsa.stattools.acf(x, unbiased=False, nlags=40, ...) строит график автокорреляции ряда x;
   * statsmodels.tsa.stattools.pacf(x, nlags=40, method='ywunbiased', ...) строит график частичной автокорреляции ряда x; nlags - число лагов
   * statsmodels.tsa.seasonal.seasonal_decompose(x, model='additive', разложение временного ряда х на сезонность, тренд и остаток в соответсвии с заданной моделью model; model : str {“additive”, “multiplicative”}
   * statsmodels.tsa.stattools.adfuller(x, ...) - тест Дики-Фулера для ряда x;
   * statsmodels.tsa.arima_model.ARIMA(х, order, ...) построение модели ARIMA с параметрами order; order=(p, d, q)
   * statsmodels.tsa.statespace.sarimax.SARIMAX(х, order, seasonal_order, ...) построение модели SARIMA с параметрами order и сезонными параметрами seasonal_order;
   * statsmodels.tsa.statespace.sarimax.SARIMAXResults.aic() - Akaike Information Criterion
   * statsmodels.tsa.statespace.sarimax.SARIMAXResults.predict(start=None, end=None, dynamic=False, ...)-start - задаём, с какой позиции начать предсказывать, end - зададим, до какой позиции предсказывать, dynamic=True - димнамическое построение повышает точность предсказания; возвращает предсказанные значения
* scipy.stats.boxcox(x, lmbda,...) - Трансформация Бокса — Кокса (Box-Cox transformation)
* sklearn - инструменты для машинного обучения и анализа данных;
   * r2_score(true, pred) функция регрессионной оценки с истинными значениями true и предсказнными pred;
   
 ## Инструкция по запуску
 Из командной строки:
    
    Jupyter notebook forecast.ipynb
    Cells -> Run all
    
 ## Необходимое ПО
  
  Диструбутив ***Anaconda***
  
  Графическая веб-оболочка для IPython ***Jupyter notebook***
  
## Участники
   Родин Иван - 311 группа:
   
   * Первый пункт задания
   * Подбор параметров в моделях ARIMA и SARIMAX
   * Выбор наилучшей модели
   
   
   Сумин Даниил - 311 группа:
   
   * Подбор параметров в моделях ARIMA и SARIMAX
   * Выбор наилучшей модели
   
   Шматенко Дарья - 311 группа:
   
   * Исследование на тренд, сезонность, порядок интегрированности
   * Подготовка readme
